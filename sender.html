<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Tourist Location Sender</title>
    <style>
        .container {
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white p-6 rounded-lg shadow-xl w-full">
        <h1 class="text-2xl font-bold mb-4 text-center text-indigo-700">Live Location Sender</h1>

        <div id="status" class="mb-4 p-3 bg-blue-100 border border-blue-300 rounded text-blue-700 font-medium text-sm text-center">
            Getting ready...
        </div>

        <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded">
            <p class="text-sm font-semibold text-gray-600 mb-1">Your Unique Tourist ID:</p>
            <p id="tourist-id" class="text-lg font-mono break-all text-gray-800 bg-gray-100 p-2 rounded"></p>
        </div>

        <button id="tracking-button" 
                class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out cursor-pointer disabled:opacity-50">
            Start Sending Location
        </button>

        <p id="location-display" class="mt-4 text-xs text-gray-500 text-center">
            Current Location: --
        </p>
    </div>

    <script>
        // Use a dedicated DELETE/STOP endpoint for cleaner backend logic
        const API_URL_UPDATE = "https://a7d64c80-f620-40d1-be03-4ed7af8374ae-00-6mjphf1eg2nq.kirk.repl.co/update";
        const API_URL_STOP = "https://a7d64c80-f620-40d1-be03-4ed7af8374ae-00-6mjphf1eg2nq.kirk.repl.co/stop_tracking";

        const STATUS_READY = "Ready. Click 'Start Sending Location' to begin.";
        const STATUS_TRACKING = "Tracking location in real-time (sending every 10s)...";
        const STATUS_STOPPED = "Tracking stopped. Click Start to resume.";
        const STATUS_ERROR = "Error getting location or connecting to server.";
        const STATUS_DELETING = "Stopping tracking and signaling backend to delete marker...";
        
        let touristId = '';
        let isTracking = false;
        let watchId = null;
        
        const trackingButton = document.getElementById('tracking-button');
        const statusDisplay = document.getElementById('status');
        const locationDisplay = document.getElementById('location-display');

        // --- DEVICE FINGERPRINTING FOR CROSS-BROWSER ID ---
        async function generateDeviceFingerprint() {
            // Collect stable device characteristics
            const components = [
                screen.width,
                screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                navigator.language,
                navigator.platform,
                // Use a simplified userAgent to avoid browser-specific version numbers
                navigator.userAgent.replace(/[\d.]+/g, 'X')
            ];
            
            // Create a stable string from components
            const fingerprintString = components.join('|');
            
            // Hash the fingerprint to create a hex ID
            const encoder = new TextEncoder();
            const data = encoder.encode(fingerprintString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // Return first 16 characters (similar to UUID format)
            return hashHex.substring(0, 16);
        }

        // --- 1. ID GENERATION AND INITIALIZATION ---
        async function initializeTouristId() {
            // Try to get from localStorage first (for consistency within same browser)
            let existingId = localStorage.getItem('touristId');
            
            if (existingId) {
                touristId = existingId;
            } else {
                // Generate ID based on device fingerprint (works across browsers)
                touristId = await generateDeviceFingerprint();
                localStorage.setItem('touristId', touristId);
            }
            
            document.getElementById('tourist-id').textContent = touristId;
            statusDisplay.textContent = STATUS_READY;
            trackingButton.disabled = false;
        }
        
        // --- 2. CORE SENDING LOGIC ---
        async function sendLocation(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const timestamp = new Date().toLocaleTimeString();

            locationDisplay.textContent = 
                `Last Sent at ${timestamp} | Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;

            const payload = {
                tourist_id: touristId,
                latitude: lat,
                longitude: lon,
                action: 'update'
            };

            try {
                const response = await fetch(API_URL_UPDATE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error('Server error:', response.status);
                }

            } catch (error) {
                console.error('Network or CORS error:', error);
                statusDisplay.textContent = STATUS_ERROR;
            }
        }

        // --- 3. EXPLICIT STOP SIGNAL LOGIC (Marker Deletion) ---
        async function signalStopTracking() {
            statusDisplay.textContent = STATUS_DELETING;

            const payload = {
                tourist_id: touristId,
                action: 'delete' 
            };

            try {
                const response = await fetch(API_URL_STOP, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error('Stop signal server error:', response.status);
                    statusDisplay.textContent = "Error signaling stop. Check console.";
                } else {
                    statusDisplay.textContent = STATUS_STOPPED;
                }

            } catch (error) {
                console.error('Stop signal network error:', error);
                statusDisplay.textContent = STATUS_STOPPED + " (Signal Failed)";
            }
        }

        // --- 4. ERROR HANDLER ---
        function handleError(error) {
            console.error('Geolocation Error:', error);
            statusDisplay.textContent = `${STATUS_ERROR} (Code: ${error.code})`;
            
            if (isTracking) {
                stopTracking();
            }
        }
        
        // --- 5. START / STOP HANDLERS ---
        function startTracking() {
            if (!navigator.geolocation) {
                statusDisplay.textContent = STATUS_ERROR;
                return;
            }

            trackingButton.textContent = 'Stop Tracking';
            trackingButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            trackingButton.classList.add('bg-red-600', 'hover:bg-red-700');
            statusDisplay.textContent = STATUS_TRACKING;
            isTracking = true;

            watchId = navigator.geolocation.watchPosition(
                sendLocation, 
                handleError, 
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 7000
                }
            );
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            signalStopTracking();

            trackingButton.textContent = 'Start Sending Location';
            trackingButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            trackingButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            isTracking = false;
            locationDisplay.textContent = "Current Location: --";
        }

        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }

        // --- 6. INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTouristId();
            
            trackingButton.addEventListener('click', toggleTracking);
        });

        window.addEventListener('beforeunload', () => {
             if (isTracking) {
                 signalStopTracking(); 
             }
        });
    </script>
</body>
</html>
